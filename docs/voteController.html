<!DOCTYPE html>

<html>
<head>
  <title>voteController.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="AuthConfig.html">
                AuthConfig.js
              </a>
            
              
              <a class="source" href="authPassport.html">
                authPassport.js
              </a>
            
              
              <a class="source" href="localSignUp.html">
                localSignUp.js
              </a>
            
              
              <a class="source" href="newAuthPassport.html">
                newAuthPassport.js
              </a>
            
              
              <a class="source" href="middleware.html">
                middleware.js
              </a>
            
              
              <a class="source" href="favorModel.html">
                favorModel.js
              </a>
            
              
              <a class="source" href="photoModel.html">
                photoModel.js
              </a>
            
              
              <a class="source" href="userModel.html">
                userModel.js
              </a>
            
              
              <a class="source" href="voteModel.html">
                voteModel.js
              </a>
            
              
              <a class="source" href="votePhotoModel.html">
                votePhotoModel.js
              </a>
            
              
              <a class="source" href="favorController.html">
                favorController.js
              </a>
            
              
              <a class="source" href="favorRoutes.html">
                favorRoutes.js
              </a>
            
              
              <a class="source" href="photoController.html">
                photoController.js
              </a>
            
              
              <a class="source" href="photoRoutes.html">
                photoRoutes.js
              </a>
            
              
              <a class="source" href="pushNotify.html">
                pushNotify.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
              
              <a class="source" href="drakeapp-spec.html">
                drakeapp-spec.js
              </a>
            
              
              <a class="source" href="binaryHeap.html">
                binaryHeap.js
              </a>
            
              
              <a class="source" href="userController.html">
                userController.js
              </a>
            
              
              <a class="source" href="userRoutes.html">
                userRoutes.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="voteController.html">
                voteController.js
              </a>
            
              
              <a class="source" href="votePhotoController.html">
                votePhotoController.js
              </a>
            
              
              <a class="source" href="voteRoutes.html">
                voteRoutes.js
              </a>
            
              
              <a class="source" href="instagramRoutes.html">
                instagramRoutes.js
              </a>
            
              
              <a class="source" href="instagramScrape.html">
                instagramScrape.js
              </a>
            
              
              <a class="source" href="twitterRoutes.html">
                twitterRoutes.js
              </a>
            
              
              <a class="source" href="twitterScrape.html">
                twitterScrape.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>voteController.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Favor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/favorModel.js'</span>);
<span class="hljs-keyword">var</span> Photo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/photoModel.js'</span>);
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);

<span class="hljs-keyword">var</span> Q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);
<span class="hljs-keyword">var</span> Vote = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/voteModel.js'</span>);

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Function does both upvoting and downvoting
   * @method upVote
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  upVote: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Query the Vote table for entries with a certain userID and favorID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Vote.findOne({
      userID: req.user.provider_id,
      favorID: req.body.favor._id
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, vote</span>) </span>{
      
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"favorID"</span>, req.body.favor._id);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"THIS IS USER VOTE! "</span>+vote);
      <span class="hljs-built_in">console</span>.log(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>console.log(‘ERROR in finding user on login: ‘, err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> (err);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>console.log(‘LOGIN no error, user: ‘, user);</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>check if there’s already a vote by this user…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!err &amp;&amp; vote != <span class="hljs-literal">null</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'you already voted on that...'</span>); 
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.body.vote"</span>, req.body.vote);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"vote.vote"</span>, vote.vote);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If req.body.vote = 1, upvote; 0, nuetral; -1, downvote
If sending an upvote, check if there is already a downvote</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (req.body.vote === <span class="hljs-number">1</span> &amp;&amp; (vote.vote ===-<span class="hljs-number">1</span> || vote.vote ===<span class="hljs-number">0</span>))  {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Increase the votes by 1 in both the votes and favors tables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: <span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'succesfully did findbyidandupdate'</span>);
                Favor.findByIdAndUpdate(req.body.favor._id, 
                { $inc: {votes: <span class="hljs-number">1</span> } }, 
                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                  User.findByIdAndUpdate(req.user._id,
                    { $inc: {points: <span class="hljs-number">1</span> } },
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'succesfully did points!!!!!!!!!!!!!'</span>);
                      res.send(<span class="hljs-string">'1'</span>);
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>console.log(“AWWWW im in callback”)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                });
              });


        }

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.body.vote === -<span class="hljs-number">1</span> &amp;&amp; (vote.vote === <span class="hljs-number">1</span>|| vote.vote ===<span class="hljs-number">0</span>)){</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Decrease a specific entry in both the favor and vote table by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: -<span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                  Favor.findByIdAndUpdate(req.body.favor._id, 
                  { $inc: {votes: -<span class="hljs-number">1</span> } }, 
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                        <span class="hljs-keyword">if</span> (data.votes &lt;= -<span class="hljs-number">4</span>) {
                          data.remove()
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.votes &gt; -<span class="hljs-number">5</span>){
                          User.findByIdAndUpdate(req.user._id,
                            { $inc: {points: -<span class="hljs-number">1</span> } },
                            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                              res.send(<span class="hljs-string">'-1'</span>);
                            });
                        }
                  });
              });
          
        } <span class="hljs-keyword">else</span> { 
          res.send(<span class="hljs-string">'0'</span>); 
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>//otherwise, you’ve already voted. send back 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Create a new vote entry and save it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> vote = <span class="hljs-keyword">new</span> Vote({
        userID: req.user.provider_id,
        favorID: req.body.favor._id,
        vote: req.body.vote
      });
      vote.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR in user creation on login: '</span>, err);
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;

        <span class="hljs-keyword">if</span>( vote.vote === <span class="hljs-number">1</span>) {
          Favor.findByIdAndUpdate(req.body.favor._id,
            { $inc: {votes: <span class="hljs-number">1</span>} },
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
              res.send(<span class="hljs-string">'1'</span>);
            });
        } <span class="hljs-keyword">else</span> { 
          Favor.findByIdAndUpdate(req.body.favor._id,
          { $inc: {votes: -<span class="hljs-number">1</span>} },
          <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            res.send(<span class="hljs-string">'-1'</span>); 
          });
        }
      });
      }
    });
    

  },


  <span class="hljs-comment">/**
   * This function does both upvoting and downvoting for photos
   * @method upVotePhoto
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  upVotePhoto: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Query the Vote table for a specific entry with a certain photo/userID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Vote.findOne({
      userID: req.user.provider_id,
      photoID: req.body.photo._id
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, vote</span>) </span>{
      
      <span class="hljs-built_in">console</span>.log(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>console.log(‘ERROR in finding user on login: ‘, err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> (err);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>check if there’s already a vote by this user…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!err &amp;&amp; vote != <span class="hljs-literal">null</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'you already voted on that...'</span>); 
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.body.vote"</span>, req.body.vote);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"vote.vote"</span>, vote.vote);
        <span class="hljs-keyword">if</span> (req.body.vote === <span class="hljs-number">1</span> &amp;&amp; (vote.vote ===-<span class="hljs-number">1</span> || vote.vote ===<span class="hljs-number">0</span>))  { <span class="hljs-comment">//if sending an upvote, check if there is already a downvote</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>find that exact vote, photo, and up the user’s kudos by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: <span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                Photo.findByIdAndUpdate(req.body.photo._id, 
                { $inc: {votes: <span class="hljs-number">1</span> } }, 
                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                  User.findByIdAndUpdate(req.user._id,
                    { $inc: {points: <span class="hljs-number">1</span> } },
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                      res.send(<span class="hljs-string">'1'</span>);
                    });
                });
              });

        }

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.body.vote === -<span class="hljs-number">1</span> &amp;&amp; (vote.vote === <span class="hljs-number">1</span>|| vote.vote ===<span class="hljs-number">0</span>)){</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>find that exact vote, photo, and down the user’s kudos by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: -<span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                Photo.findByIdAndUpdate(req.body.photo._id, 
                { $inc: {votes: -<span class="hljs-number">1</span> } }, 
                  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                    <span class="hljs-keyword">if</span> (data.votes &lt;= -<span class="hljs-number">4</span>) {
                      data.remove()
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.votes &gt; -<span class="hljs-number">5</span>){
                      User.findByIdAndUpdate(req.user._id,
                        { $inc: {points: -<span class="hljs-number">1</span> } },
                        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                          res.send(<span class="hljs-string">'1'</span>);
                        });
                    }
                  });
              });
          
        } <span class="hljs-keyword">else</span> { 
          res.send(<span class="hljs-string">'0'</span>); 
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>//otherwise, you’ve already voted. send back 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Create a new vote table if one does not already exist!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> vote = <span class="hljs-keyword">new</span> Vote({
        userID: req.user.provider_id,
        photoID: req.body.photo._id,
        vote: req.body.vote
      });
      vote.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR in user creation on login: '</span>, err);
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;

        <span class="hljs-keyword">if</span>( vote.vote === <span class="hljs-number">1</span>) {
          Photo.findByIdAndUpdate(req.body.photo._id,
            { $inc: {votes: <span class="hljs-number">1</span>} },
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
              res.send(<span class="hljs-string">'1'</span>);
            });
        } <span class="hljs-keyword">else</span> { 
          Photo.findByIdAndUpdate(req.body.photo._id,
          { $inc: {votes: -<span class="hljs-number">1</span>} },
          <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            res.send(<span class="hljs-string">'-1'</span>); 
          });
        }
      });
      }
    });
    

  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
