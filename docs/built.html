<!DOCTYPE html>

<html>
<head>
  <title>built.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>built.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = {
 twitter: {
   key: <span class="hljs-string">''</span>,
   secret: <span class="hljs-string">''</span>
 },
 facebook: {
   <span class="hljs-string">"clientID"</span>: <span class="hljs-string">"1443792965917018"</span>,
   <span class="hljs-string">"clientSecret"</span>: <span class="hljs-string">"7650cb7ec94fe197901a90d00d7da8c5"</span>,
   <span class="hljs-string">"callbackURL"</span>: <span class="hljs-string">"http://localhost:3000/auth/facebook/callback"</span>

 }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>add this;var User = require(‘../db/userModel.js’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> FacebookStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-facebook'</span>).Strategy;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>API keys configuration file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./AuthConfig'</span>);

<span class="hljs-comment">/**
 * Description
 * @method authenticated
 * @param {} req
 * @return LogicalExpression
 */</span>
<span class="hljs-keyword">var</span> authenticated = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req</span>) </span>{
  <span class="hljs-keyword">return</span> req.session &amp;&amp; req.session.passport &amp;&amp; req.session.passport.user;
}

<span class="hljs-comment">/**
 * Authenticates requests.
 *
 * Applies the Facebook authentication strategy to the incoming request
 * If authentication is successful the user will be logged in
 * and populated at `req.session.passport` and a session will be
 * established.  
 *
 * @api public
 */</span>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Initializes the FacebookStrategy to create a user object if needed
   * on successful authentication
   * @api public
   * @method init
   * @param {Passport} passport authentication 
   * @return 
   */</span>
  init: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">passport</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Serialize the user for storing it in the session</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>console.log(‘serializeUser ‘, user);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      done(<span class="hljs-literal">null</span>, user);
    });

    passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(‘deserializeUser ‘, obj);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      done(<span class="hljs-literal">null</span>, obj);
    });

    passport.use(<span class="hljs-keyword">new</span> FacebookStrategy({
      clientID: config.facebook.clientID,
      clientSecret: config.facebook.clientSecret,
      callbackURL: <span class="hljs-string">'/auth/facebook/callback'</span>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">accessToken, refreshToken, profile, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>console.log(“THIS iS THE PROFILE “+JSON.stringify(profile));
console.log(“THIS IS PROFILE URL “+profile.profileUrl);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      User.findOne({
        provider_id: profile.id
      }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>console.log(‘ERROR in finding user on login: ‘, err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> (err);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>console.log(‘LOGIN no error, user: ‘, user);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">if</span> (!err &amp;&amp; user != <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, user);
        }

        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Please don't break! "</span>+<span class="hljs-built_in">JSON</span>.stringify(profile));
        <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User({
          provider_id: profile.id,
          provider: profile.provider,
          name: profile.displayName,
          photo: profile.profileUrl
        });
        user.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR in user creation on login: '</span>, err);
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
          done(<span class="hljs-literal">null</span>, user);
        });
      });
    }));

  },

  <span class="hljs-comment">/**
   * For authenticating api calls, returns 401 if not authenticated
   *  
   * @api public
   * @method authenticate
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  authenticate: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">if</span> (authenticated(req)) {
      <span class="hljs-keyword">return</span> next();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">401</span>);
    }
  },

  <span class="hljs-comment">/**
   * For protecting static assets, redirects to /signin.html
   *  
   * @api public
   * @method signInIfNotAuthenticated
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  signInIfNotAuthenticated: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">if</span> (authenticated(req)) {
      next();
    } <span class="hljs-keyword">else</span> {
      res.redirect(<span class="hljs-string">'/signin.html'</span>)
    }
  }

};;<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);
<span class="hljs-keyword">var</span> LocalStrategy  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy;

<span class="hljs-comment">/**
 * Description
 * @method authenticated
 * @param {} req
 * @return LogicalExpression
 */</span>
<span class="hljs-keyword">var</span> authenticated = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req</span>) </span>{
  <span class="hljs-keyword">return</span> req.session &amp;&amp; req.session.passport &amp;&amp; req.session.passport.user;
}


<span class="hljs-built_in">module</span>.exports = {

  <span class="hljs-comment">/**
   * Description
   * @method init
   * @param {} passport
   * @return 
   */</span>
  init: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">passport</span>) </span>{

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"I'm inside!"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>used to serialize the user for the session</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, done</span>) </span>{
        done(<span class="hljs-literal">null</span>, user.id);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>used to deserialize the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, done</span>) </span>{
        User.findById(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
            done(err, user);
        });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>=========================================================================</p>
<h1 id="local-signup-">LOCAL SIGNUP ============================================================</h1>
<p>we are using named strategies since we have one for login and one for signup
by default, if there was no name, it would just be called ‘local’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    passport.use(<span class="hljs-string">'local-signup'</span>, <span class="hljs-keyword">new</span> LocalStrategy({</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>by default, local strategy uses username and password, we will override with email</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        usernameField : <span class="hljs-string">'email'</span>,
        passwordField : <span class="hljs-string">'password'</span>,
        passReqToCallback : <span class="hljs-literal">true</span> <span class="hljs-comment">// allows us to pass back the entire request to the callback</span>
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, email, password, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>asynchronous
User.findOne wont fire unless data is sent back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>find a user whose email is the same as the forms email
we are checking to see if the user trying to login already exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        User.findOne({ <span class="hljs-string">'local.email'</span> :  req.body.email }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if there are any errors, return the error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (err)
                <span class="hljs-keyword">return</span> done(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>check to see if theres already a user with that email</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (user) {
                <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, req.flash(<span class="hljs-string">'signupMessage'</span>, <span class="hljs-string">'That email is already taken.'</span>));
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>if there is no user with that email
create the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> newUser            = <span class="hljs-keyword">new</span> User();</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>set the user’s local credentials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                newUser.local.email    = req.body.email;
                newUser.local.password = newUser.generateHash(req.body.password);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>save the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                newUser.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                    <span class="hljs-keyword">if</span> (err)
                        <span class="hljs-keyword">throw</span> err;
                    <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, newUser);
                });
            }

        });    

        });

    }));

},

  <span class="hljs-comment">/**
   * For authenticating api calls, returns 401 if not authenticated
   *  
   * @api public
   * @method authenticate
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  authenticate: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">if</span> (authenticated(req)) {
      <span class="hljs-keyword">return</span> next();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">401</span>);
    }
  },

  <span class="hljs-comment">/**
   * For protecting static assets, redirects to /signin.html
   *  
   * @api public
   * @method signInIfNotAuthenticated
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  signInIfNotAuthenticated: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">if</span> (authenticated(req)) {
      next();
    } <span class="hljs-keyword">else</span> {
      res.redirect(<span class="hljs-string">'/signin.html'</span>)
    }
  }

};;<span class="hljs-keyword">var</span>  FacebookTokenStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-facebook-token'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>var request = require(“request”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> configAuth = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./AuthConfig.js'</span>);
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);


<span class="hljs-comment">/**
 * Passport configuration
 * @method exports
 * @param {} passport
 * @return 
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">passport</span>) </span>{

  passport.use( <span class="hljs-keyword">new</span> FacebookTokenStrategy({</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>set clientID and clientSecret (from facebook app settings)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clientID : process.env.ClientID || configAuth.facebook.clientID,
  clientSecret : process.env.ClientSecret || configAuth.facebook.clientSecret
  }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">accessToken, refereshToken, profile, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>console.log(“WE ARE INSIDE THE NEW FB “, profile)</p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Look for user inside the Mongo database by profile id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    User.findOne( { provider_id: profile.id },
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If not found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(!user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Create user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User({ name: profile.displayName,
                          provider: profile.provider,
                          provider_id: profile.id
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Save the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          user.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error!'</span>);
            }
      
            <span class="hljs-keyword">return</span> done(err, user);
          });
        } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> done(err, user); }

      });

  }));
}

;<span class="hljs-comment">//Different NPM Modules</span>
<span class="hljs-keyword">var</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>var request = require(‘request’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>User Model Schema</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Auth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> auth = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../auth/authPassport'</span>);
<span class="hljs-keyword">var</span> fbAuth = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../auth/newAuthPassport'</span>)(passport);
 
<span class="hljs-comment">/**
 * Core Middleware
 * Sets up top-level routes, authentication, and session initialization
 */</span>

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app, express</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Passport initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  auth.init(passport);
  app.use(passport.initialize());
  app.use(passport.session());</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Passport Routes </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.get(<span class="hljs-string">'/logout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    req.logout();
    res.redirect(<span class="hljs-string">'/'</span>);
  });

  app.use(cookieParser(<span class="hljs-string">'add a secret here'</span>));
  app.use(session({ secret: <span class="hljs-string">'xyz-qwrty'</span>, resave: <span class="hljs-literal">false</span>, saveUninitialized: <span class="hljs-literal">true</span> }));

  <span class="hljs-keyword">var</span> photoRouter = express.Router();
  <span class="hljs-keyword">var</span> favorRouter = express.Router();
  <span class="hljs-keyword">var</span> voteRouter = express.Router();
  <span class="hljs-keyword">var</span> userRouter = express.Router();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Used for logging request details</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(morgan(<span class="hljs-string">'dev'</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Allows the use of req.body</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(bodyParser.urlencoded({extended: <span class="hljs-literal">true</span>}));
  app.use(bodyParser.json());</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>app.get(‘/‘, auth.signInIfNotAuthenticated);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(<span class="hljs-string">'/index.html'</span>, auth.signInIfNotAuthenticated);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Serve the static files from the Front-End</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(express.static(path.join(__dirname,<span class="hljs-string">'/../../client/www'</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>On every subsequent http request from the Front-End, it will attach these headers to the response</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>) </span>{
    res.header(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
    res.header(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"X-Requested-With, access_token"</span>);
    next();
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Routes from Front-End $http requests to their respective routers; authenticated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(<span class="hljs-string">'/api/requests'</span>, passport.authenticate(<span class="hljs-string">'facebook-token'</span>), favorRouter);
  app.use(<span class="hljs-string">'/api/photos'</span>, passport.authenticate(<span class="hljs-string">'facebook-token'</span>), photoRouter);
  app.use(<span class="hljs-string">'/api/votes'</span>, passport.authenticate(<span class="hljs-string">'facebook-token'</span>), voteRouter);
  app.use(<span class="hljs-string">'/api/users'</span>, passport.authenticate(<span class="hljs-string">'facebook-token'</span>), userRouter);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Used to grab user information from the user property of the request. 
Provides FB info for name and profile picture</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.get(<span class="hljs-string">'/api/profileID'</span>, passport.authenticate(<span class="hljs-string">'facebook-token'</span>), 
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
      res.send(req.user);
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Adding routes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../favors/favorRoutes.js'</span>)(favorRouter);
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../photos/photoRoutes.js'</span>)(photoRouter);
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../votes/voteRoutes.js'</span>)(voteRouter);
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../users/userRoutes.js'</span>)(userRouter);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Setting up twitter and instagram scraping routes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/*var twitterScrapeRouter = express.Router();
  app.use('/api/twitter', <span class="hljs-comment">/*auth.athenticate*/</span> <span class="hljs-comment">/*twitterScrapeRouter);
  require("../webScraping/twitterRoutes.js")(twitterScrapeRouter);*/</span>

  <span class="hljs-comment">/*var instagramScrapeRouter = express.Router();
  app.use('/api/instagram', <span class="hljs-comment">/*auth.athenticate*/</span> <span class="hljs-comment">/*instagramScrapeRouter);
  require("../webScraping/instagramRoutes.js")(instagramScrapeRouter);*/</span>

  app.post('/auth/facebook/token',
    passport.authenticate('facebook-token'),
      function (req,res) {
        console.log('authorized user!');
</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>console.log(req.user);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.send(req.user? <span class="hljs-number">201</span> : <span class="hljs-number">401</span>)
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Multer is an NPM module used to upload multi-part data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(multer({ dest: <span class="hljs-string">'./uploads/'</span>, 
    rename: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fieldname, filename</span>) </span>{
              <span class="hljs-built_in">console</span>.log(fieldname);
              <span class="hljs-built_in">console</span>.log(filename);
              <span class="hljs-keyword">return</span> filename;
            }
  }));</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Used to chunk the photos into one coherent file before uploading them to S3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.post(<span class="hljs-string">'/photoUploads/uploadToServer'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"_________________"</span>);
     <span class="hljs-built_in">console</span>.log(req.files);
    res.redirect(<span class="hljs-string">'/photoUploads/uploadToS3/?fileName='</span> + req.files.file.originalname);
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Sending photos to S3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.get(<span class="hljs-string">'/photoUploads/uploadToS3/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{

      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"THIS IS THE UPLOAD S3 BODY!"</span>+<span class="hljs-built_in">JSON</span>.stringify(req.body));

       <span class="hljs-keyword">var</span> fmt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fmt'</span>);
       <span class="hljs-keyword">var</span> amazonS3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'awssum-amazon-s3'</span>);
       <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Setting up access keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>       <span class="hljs-keyword">var</span> s3 = <span class="hljs-keyword">new</span> amazonS3.S3({
           <span class="hljs-string">'accessKeyId'</span>     : process.env.AWS_ACCESS_KEY_DARREN,
           <span class="hljs-string">'secretAccessKey'</span> : process.env.AWS_SECRET_KEY_DARREN,
           <span class="hljs-string">'region'</span>          : <span class="hljs-string">"us-east-1"</span>
       });

      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"^^^^^^^^^^^^^^^^"</span>);
       <span class="hljs-built_in">console</span>.log(req.query.fileName);
       <span class="hljs-keyword">var</span> fileName = req.query.fileName;
       <span class="hljs-keyword">var</span> favorID = (fileName.split(<span class="hljs-string">"___"</span>))[<span class="hljs-number">1</span>].slice(<span class="hljs-number">0</span>,-<span class="hljs-number">4</span>);
       <span class="hljs-built_in">console</span>.log(favorID);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>you must run fs.stat to get the file size for the content-length header (s3 requires this)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>       fs.stat(<span class="hljs-string">"./uploads/"</span>+fileName, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file_info</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"{}{}{}{}{}{}{}{}{}{}}"</span>);
          <span class="hljs-built_in">console</span>.log(req.files);
           <span class="hljs-keyword">var</span> bodyStream = fs.createReadStream(<span class="hljs-string">"./uploads/"</span>+fileName);
           <span class="hljs-keyword">var</span> options = {
               BucketName    : <span class="hljs-string">"darrendrakeapp"</span>,
               ObjectName    : fileName,
               ContentLength : file_info.size,
               Body          : bodyStream
           };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Actually sends data to S3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           s3.PutObject(options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
             <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"im in putobject function"</span>);


               fmt.dump(err, <span class="hljs-string">'err'</span>);
               fmt.dump(data, <span class="hljs-string">'data'</span>);
           });
       });


    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"_____________"</span>);
    res.send(<span class="hljs-string">'upload complete'</span>);
  });
}

;<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-comment">/* favors/requests, created by users.
 * a user creates a request for a photo fitting the description, located in the specified area.
 * as users fulfill the request, photos are added to the request.
 * favors belong to a user.
 */</span>

<span class="hljs-keyword">var</span> FavorSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  topic: <span class="hljs-built_in">String</span>,
  description: <span class="hljs-built_in">String</span>,
  user_id: <span class="hljs-built_in">Number</span>,  <span class="hljs-comment">// provider_id</span>
  icon: <span class="hljs-built_in">String</span>,
  place_name: <span class="hljs-built_in">String</span>,
  address: <span class="hljs-built_in">String</span>,
  loc: {
   <span class="hljs-string">'type'</span>: {type: <span class="hljs-built_in">String</span>, enum: <span class="hljs-string">"Point"</span>, <span class="hljs-keyword">default</span>: <span class="hljs-string">"Point"</span>},
   <span class="hljs-string">'coordinates'</span>: { type: [<span class="hljs-built_in">Number</span>],   <span class="hljs-keyword">default</span>: [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]} 
  },
  votes: <span class="hljs-built_in">Number</span>,
  isPrivate: <span class="hljs-built_in">Boolean</span>,
  createdAt: { type: <span class="hljs-built_in">Date</span>, expires: <span class="hljs-number">86400</span>, <span class="hljs-keyword">default</span>: <span class="hljs-built_in">Date</span>.now }
});

FavorSchema.index({loc: <span class="hljs-string">'2dsphere'</span>});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'favor'</span>, FavorSchema);

; <span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-comment">/* photos taken by users to fulfill requests/favors.
 * photos are attached to a user and a request.
 */</span>

<span class="hljs-keyword">var</span> PhotoSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  url: <span class="hljs-built_in">String</span>,
  request_id: <span class="hljs-built_in">String</span>,
  user_id: <span class="hljs-built_in">String</span>,
  votes: { type: <span class="hljs-built_in">Number</span>, <span class="hljs-keyword">default</span>: <span class="hljs-number">0</span> },
  loc: {
   <span class="hljs-string">'type'</span>: {type: <span class="hljs-built_in">String</span>, enum: <span class="hljs-string">"Point"</span>, <span class="hljs-keyword">default</span>: <span class="hljs-string">"Point"</span>},
   <span class="hljs-string">'coordinates'</span>: { type: [<span class="hljs-built_in">Number</span>],   <span class="hljs-keyword">default</span>: [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]} 
  },
  createdAt: { type: <span class="hljs-built_in">Date</span>, expires: <span class="hljs-number">86400</span>, <span class="hljs-keyword">default</span>: <span class="hljs-built_in">Date</span>.now },
  icon: <span class="hljs-built_in">String</span>
});

PhotoSchema.index({loc: <span class="hljs-string">'2dsphere'</span>});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'photo'</span>, PhotoSchema);

;<span class="hljs-comment">// Database user model</span>

<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;

<span class="hljs-keyword">var</span> UserSchema = <span class="hljs-keyword">new</span> Schema({
	name: <span class="hljs-built_in">String</span>, <span class="hljs-comment">// user name</span>
	notify_favors: <span class="hljs-built_in">Boolean</span>, <span class="hljs-comment">// push notify for new nearby favors</span>
	notify_photos: <span class="hljs-built_in">Boolean</span>, <span class="hljs-comment">// push notify for photos for my favors</span>
  screen_name : <span class="hljs-built_in">String</span>,
	provider: <span class="hljs-built_in">String</span>, <span class="hljs-comment">// Twitter, Facebook, etc</span>
	provider_id : {type: <span class="hljs-built_in">String</span>, unique: <span class="hljs-literal">true</span>}, <span class="hljs-comment">// id returned by Twitter, Facebook, etc.</span>
	photo: <span class="hljs-built_in">String</span>, <span class="hljs-comment">// user's photo or avatar,</span>
	points: <span class="hljs-built_in">Number</span>,
	loc: {
   <span class="hljs-string">'type'</span>: {type: <span class="hljs-built_in">String</span>, enum: <span class="hljs-string">"Point"</span>, <span class="hljs-keyword">default</span>: <span class="hljs-string">"Point"</span>},
   <span class="hljs-string">'coordinates'</span>: { type: [<span class="hljs-built_in">Number</span>],   <span class="hljs-keyword">default</span>: [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]} 
  },
	createdAt: {type: <span class="hljs-built_in">Date</span>, <span class="hljs-keyword">default</span>: <span class="hljs-built_in">Date</span>.now}
});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'users'</span>, UserSchema);
;<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;

<span class="hljs-keyword">var</span> VoteSchema = <span class="hljs-keyword">new</span> Schema({
  userID: <span class="hljs-built_in">String</span>, <span class="hljs-comment">// userID</span>
  favorID: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//favorID</span>
  photoID: <span class="hljs-built_in">String</span>,
  vote: <span class="hljs-built_in">Number</span>, <span class="hljs-comment">// 0(Neutral), 1(upvote), -1(downvote)</span>
});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'votes'</span>, VoteSchema);;<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;

<span class="hljs-keyword">var</span> VotePhotoSchema = <span class="hljs-keyword">new</span> Schema({
	userID: <span class="hljs-built_in">String</span>, <span class="hljs-comment">// userID</span>
  photoID: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//favorID</span>
	vote: <span class="hljs-built_in">Number</span>, <span class="hljs-comment">// 0(Neutral), 1(upvote), -1(downvote)</span>
});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'votePhotos'</span>, VotePhotoSchema);;<span class="hljs-keyword">var</span> Favor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/favorModel.js'</span>);
<span class="hljs-keyword">var</span> Photo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/photoModel.js'</span>);
<span class="hljs-keyword">var</span> Notifier = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../push/pushNotify.js'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils/utils.js'</span>);
<span class="hljs-keyword">var</span> Q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Queries the databsse for favors inside the given box
   * @method fetchFavors
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  fetchFavors: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  	<span class="hljs-keyword">var</span> box = req.body.box;
    <span class="hljs-keyword">var</span> query = Favor.find(utils.getPolyBoxQuery(box));
    query.exec(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, docs</span>) </span>{
      res.json(docs);
      <span class="hljs-keyword">if</span> (err) {
        res.send(<span class="hljs-string">'ERROR in Favor.find '</span> + err)
      }
    });
  },
  
  <span class="hljs-comment">/**
   * This function adds favors to the database.
   * @method createFavor
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  createFavor: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> favor = <span class="hljs-keyword">new</span> Favor({
      topic: req.body.topic,
      description: req.body.description,
      place_name: req.body.place_name,
      address: req.body.address,
      user_id: req.user.provider_id,
      photos: [],
      icon: req.body.icon,
      loc: {
        <span class="hljs-string">"coordinates"</span>: [req.body.location.F, req.body.location.A]
      },
      votes: <span class="hljs-number">0</span>,
      isPrivate: <span class="hljs-literal">false</span>
    });
    favor.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, favor</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR in favor creation: '</span>, err);
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">throw</span> err;
      } <span class="hljs-keyword">else</span> {
        Notifier.notifyNewFavor(favor);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>done(null, user);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      res.send(favor);
    });
  },

  <span class="hljs-comment">/**
   * This function grabs favors for a specific user. Used for profile page
   * @method grabFavor
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  grabFavor: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    Favor.find(
      {user_id : req.user.provider_id},  
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
        res.json(data);
    });
  }
}
;<span class="hljs-keyword">var</span> favorController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./favorController.js'</span>);

<span class="hljs-comment">/**
 * Description
 * @method exports
 * @param {} app
 * @return 
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
  app.route(<span class="hljs-string">'/'</span>)
    .post(favorController.fetchFavors);

  app.route(<span class="hljs-string">'/create'</span>)
    .post(favorController.createFavor);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>app.route(‘/update’)
  .post(favorController.updateFavor);</p>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>app.route(‘/upVote’)
  .post(favorController.upVoteFavor);</p>

            </div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>app.route(‘/downVote’)
  .post(favorController.downVoteFavor);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  app.route(<span class="hljs-string">'/grabFavor'</span>)
    .post(favorController.grabFavor);
};;<span class="hljs-keyword">var</span> Photo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/photoModel.js'</span>);
<span class="hljs-keyword">var</span> Notifier = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../push/pushNotify.js'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>var Q = require(‘q’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> aws = <span class="hljs-built_in">require</span>(<span class="hljs-string">'aws-sdk'</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'uuid'</span>);
<span class="hljs-keyword">var</span> AWS_ACCESS_KEY = process.env.AWS_ACCESS_KEY;
<span class="hljs-keyword">var</span> AWS_SECRET_KEY = process.env.AWS_SECRET_KEY;
<span class="hljs-keyword">var</span> S3_BUCKET = process.env.S3_BUCKET;

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Creates a new photo entry in the Photo table
   * @method createPhoto
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  createPhoto: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Create a new Photo and Save it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> photo = <span class="hljs-keyword">new</span> Photo({ url: req.body.image, 
                            request_id: req.body.favor_id,
                            user_id: req.user.provider_id
                                });
          photo.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            <span class="hljs-keyword">if</span>(err) { <span class="hljs-built_in">console</span>.log(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>A photo was taken for your favor “description” at PLACE_NAME
need to fetch favor from database
notification.newPhoto send </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Notifier.notifyNewPhoto(req.body.favor_id);
            res.status(<span class="hljs-number">201</span>).send(<span class="hljs-string">'Photo saved at https://drakeapp-photos.s3.amazonaws.com/.jpg'</span>);
          });
  },

  <span class="hljs-comment">/**
   * Creates a new dummy photo for testing purposes
   * @method createDummyPhoto
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  createDummyPhoto: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> photo = <span class="hljs-keyword">new</span> Photo({ url: req.body.url, 
                            request_id: req.body.favor_id
                          });
    photo.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, photo</span>) </span>{
      <span class="hljs-keyword">if</span>(err) { <span class="hljs-built_in">console</span>.log(err); }
      res.status(<span class="hljs-number">201</span>).send(photo);
    });

  },

  <span class="hljs-comment">/**
   * Query the Photo table for a photos from a certain favor
   * @method fetchPhotosForFavor
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  fetchPhotosForFavor: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> query = Photo.find({
      request_id: req.body.favor_id
    });
    query.exec(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, docs</span>) </span>{
      res.json(docs);
      <span class="hljs-keyword">if</span> (err) {
        res.send(<span class="hljs-string">'ERROR in fetchPhotosForFavor '</span> + err)
      }
    });
  },

  <span class="hljs-comment">/**
   * This function uploads the chunkified picture to the Amazon S3 service
   * @method uploadToS3
   * @param {} req
   * @param {} res
   * @return 
   */</span>
  uploadToS3: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{

      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"THIS IS THE UPLOAD S3 BODY!"</span>+<span class="hljs-built_in">JSON</span>.stringify(req.body));

       <span class="hljs-keyword">var</span> fmt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fmt'</span>);
       <span class="hljs-keyword">var</span> amazonS3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'awssum-amazon-s3'</span>);
       <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Setting up access keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>       <span class="hljs-keyword">var</span> s3 = <span class="hljs-keyword">new</span> amazonS3.S3({
           <span class="hljs-string">'accessKeyId'</span>     : process.env.AWS_ACCESS_KEY_DARREN,
           <span class="hljs-string">'secretAccessKey'</span> : process.env.AWS_SECRET_KEY_DARREN,
           <span class="hljs-string">'region'</span>          : <span class="hljs-string">"us-east-1"</span>
       });

      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"^^^^^^^^^^^^^^^^"</span>);
       <span class="hljs-built_in">console</span>.log(req.query.fileName);
       <span class="hljs-keyword">var</span> fileName = req.query.fileName;
       <span class="hljs-keyword">var</span> favorID = (fileName.split(<span class="hljs-string">"___"</span>))[<span class="hljs-number">1</span>].slice(<span class="hljs-number">0</span>,-<span class="hljs-number">4</span>);
       <span class="hljs-built_in">console</span>.log(favorID);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>you must run fs.stat to get the file size for the content-length header (s3 requires this)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>       fs.stat(<span class="hljs-string">"./uploads/"</span>+fileName, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file_info</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"{}{}{}{}{}{}{}{}{}{}}"</span>);
          <span class="hljs-built_in">console</span>.log(req.files);
           <span class="hljs-keyword">var</span> bodyStream = fs.createReadStream(<span class="hljs-string">"./uploads/"</span>+fileName);
           <span class="hljs-keyword">var</span> options = {
               BucketName    : <span class="hljs-string">"darrendrakeapp"</span>,
               ObjectName    : fileName,
               ContentLength : file_info.size,
               Body          : bodyStream
           };</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Actually sends data to S3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           s3.PutObject(options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
             <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"im in putobject function"</span>);


               fmt.dump(err, <span class="hljs-string">'err'</span>);
               fmt.dump(data, <span class="hljs-string">'data'</span>);
           });
       });


    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"_____________"</span>);
    res.send(<span class="hljs-string">'upload complete'</span>);
  },

  <span class="hljs-comment">/**
   * This function is used to make sure the photo is completely chunkified before its sent of to the S3 servers
   * @method uploadToServer
   * @param {} req
   * @param {} res
   * @return 
   */</span>
  uploadToServer: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"_________________"</span>);
     <span class="hljs-built_in">console</span>.log(req.files);
    res.redirect(<span class="hljs-string">'api/photos/uploadToS3?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU'</span> + req.files.file.originalname);
  }
}
;<span class="hljs-keyword">var</span> photoController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./photoController.js'</span>);

<span class="hljs-comment">/**
 * Description
 * @method exports
 * @param {} app
 * @return 
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'photo router'</span>);
  app.route(<span class="hljs-string">'/create'</span>)
    .post(photoController.createPhoto);

  app.route(<span class="hljs-string">'/create-dummy'</span>)
    .post(photoController.createDummyPhoto);

  app.route(<span class="hljs-string">'/fetch'</span>)
    .post(photoController.fetchPhotosForFavor);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>app.route(‘/update’)
  .post(photoController.updatePhoto);</p>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>app.route(‘/upVote’)
  .post(photoController.upVotePhoto);</p>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>app.route(‘/downVote’)
  .post(photoController.downVotePhoto);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  app.route(<span class="hljs-string">'/uploadToS3'</span>)
    .get(photoController.uploadToS3);

  app.route(<span class="hljs-string">'/uploadToServer'</span>)
    .post(photoController.uploadToServer);
};
;<span class="hljs-keyword">var</span> favorController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../favors/favorController.js'</span>);
<span class="hljs-keyword">var</span> Favor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/favorModel.js'</span>);
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils/utils.js'</span>);
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);

<span class="hljs-comment">/**
 * Description: send a message to the push server
 * @method sendMessage
 * @param {Array} users - the provider ids of the recipients
 * @param {String} message
 * @return 
 */</span>
<span class="hljs-keyword">var</span> sendMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">users, message</span>) </span>{
  <span class="hljs-keyword">var</span> data = {
    users: users,
    android: {
      data: {
        message: message
      }
    }
  };
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'data to be send to phavr-push: '</span>, data);
  request.post({
      url: <span class="hljs-string">'http://phavr-push.herokuapp.com/send'</span>,
      json: <span class="hljs-literal">true</span>,
      headers: {
        <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span>,
      },
      body: data
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, response, body</span>) </span>{
      <span class="hljs-keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="hljs-number">200</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'response from node-pushserver: '</span>, response.statusCode, body);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error response from node-pushserver: '</span>, error, response.statusCode, body);
      }
    }
  );
}

<span class="hljs-built_in">module</span>.exports = {

  <span class="hljs-comment">/**
   * Tells the user that there is a new photo in their favor's thread
   * @method notifyNewPhoto
   * @param {} favor_id
   * @return 
   */</span>
  notifyNewPhoto: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">favor_id</span>) </span>{
    Favor.find({
        _id: favor_id
      },
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, favors</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error fetching favor for notification: '</span>, err, favors);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> favor = favors[<span class="hljs-number">0</span>];
          <span class="hljs-keyword">var</span> query = User.findOne({
            provider_id: favor.user_id
          });
          query.exec(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error finding user by id:'</span>, err);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'found user for notifyNewPhoto'</span>, <span class="hljs-built_in">JSON</span>.stringify(user, <span class="hljs-literal">null</span>, <span class="hljs-string">'\t'</span>));
              <span class="hljs-keyword">if</span> (user &amp;&amp; user.notify_photos) {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'New Photo for favor: '</span>, favor_id, favors);
                <span class="hljs-keyword">var</span> message = <span class="hljs-string">"A photo was taken for your favor \""</span> + favor.description + <span class="hljs-string">"\" at "</span> + favor.place_name;
                message += <span class="hljs-string">", "</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleString();
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'message: '</span>, message);
                sendMessage([favor.user_id], message);
              }
            }
          });
        }
      });
  },

  <span class="hljs-comment">/**
   * Tell's the user that they have entered the vicinity of a new favor
   * @method notifyNewFavor
   * @param {FavorSchema} favor
   * @return 
   */</span>
  notifyNewFavor: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">favor</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"notifyNewFavor: "</span>, favor);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'utils: '</span>, <span class="hljs-built_in">JSON</span>.stringify(utils, <span class="hljs-literal">null</span>, <span class="hljs-string">'\t'</span>));
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'new favor box: '</span>, utils.getBoxForLoc(favor.loc.coordinates));
    <span class="hljs-keyword">var</span> box = utils.getBoxForLoc(favor.loc.coordinates);
    <span class="hljs-keyword">var</span> query = User.find(utils.getPolyBoxQuery(box));
    query.exec(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, users</span>) </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"notifyNewFavor, nearby user count: "</span>, users ? users.length : <span class="hljs-number">0</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"favor user id: "</span>, favor.user_id);
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error finding users for box:'</span>, box, err);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> message = <span class="hljs-string">'There is a new favor requested near you at '</span> + favor.place_name + <span class="hljs-string">', '</span> + favor.address;
        message += <span class="hljs-string">", "</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleString();
        <span class="hljs-keyword">var</span> usersToNofify = [];
        users.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'new favor, nearby user: '</span>, user.name, <span class="hljs-string">', notify_favors: '</span>, user.notify_favors );
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ids: '</span>, user.provider_id != favor.user_id, user.provider_id, favor.user_id);
          <span class="hljs-keyword">if</span> ((user.provider_id != favor.user_id) &amp;&amp; user.notify_favors)
            usersToNofify.push(user.provider_id);
        });
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'users to notify for new favor: '</span>, usersToNofify.length);
        <span class="hljs-keyword">if</span> (usersToNofify.length &gt; <span class="hljs-number">0</span>) {
          sendMessage(usersToNofify, message);
        }
      }
    });
  }

};

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">var</span> app = express();
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> port = process.env.PORT || <span class="hljs-number">3000</span>;
<span class="hljs-keyword">var</span> db_port = process.env.MONGOLAB_URI || <span class="hljs-string">'mongodb://localhost/drakeapp'</span>;

mongoose.connect(db_port);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./config/middleware.js'</span>)(app, express);
app.listen(port);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Now listening on port"</span>, port);;<span class="hljs-keyword">var</span> drakeapp = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../server.js"</span>);
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);
<span class="hljs-keyword">var</span> frisby = <span class="hljs-built_in">require</span>(<span class="hljs-string">"frisby"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>test might fail due to expired token, check on that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> favorr

describe(<span class="hljs-string">"Authentication!"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Authentication'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/auth/facebook/token?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>)
	  .expectStatus(<span class="hljs-number">201</span>)
	.toss();
  
}); 

describe(<span class="hljs-string">"Location!"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Location'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/location?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>)
	  .expectStatus(<span class="hljs-number">404</span>)
	.toss();
  
});

describe(<span class="hljs-string">"Create A Favor!"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Make A Favor'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/api/requests/create?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	    {<span class="hljs-string">"topic"</span>:<span class="hljs-string">"lol4"</span>, <span class="hljs-string">"tags"</span>: <span class="hljs-string">"lol4"</span>, <span class="hljs-string">"description"</span>:<span class="hljs-string">"lol4"</span>,<span class="hljs-string">"place_name"</span>:<span class="hljs-string">"Hack Reactor"</span>,<span class="hljs-string">"address"</span>:<span class="hljs-string">"944 Market Street #8, San Francisco, CA 94102, United States"</span>,<span class="hljs-string">"icon"</span>:<span class="hljs-string">"http://frit-talk.com/mobile/2/endirect.png"</span>,<span class="hljs-string">"location"</span>:{<span class="hljs-string">"A"</span>: <span class="hljs-number">37.783724</span>, <span class="hljs-string">"F"</span>: -<span class="hljs-number">122.40897799999999</span>}}
	  	)
	  .expectStatus(<span class="hljs-number">200</span>)
	  .expectHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json; charset=utf-8'</span>)
	  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
	          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"THIS IS INSIDE BODY DOG! "</span>+<span class="hljs-built_in">JSON</span>.stringify(body));
	          favorr = <span class="hljs-built_in">JSON</span>.stringify(body);
	        })
	.toss();
  
});

describe(<span class="hljs-string">"Testing an upVote"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Make A Favor'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/api/requests/create?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	    {<span class="hljs-string">"topic"</span>:<span class="hljs-string">"lol4"</span>, <span class="hljs-string">"tags"</span>: <span class="hljs-string">"lol4"</span>, <span class="hljs-string">"description"</span>:<span class="hljs-string">"lol4"</span>,<span class="hljs-string">"place_name"</span>:<span class="hljs-string">"Hack Reactor"</span>,<span class="hljs-string">"address"</span>:<span class="hljs-string">"944 Market Street #8, San Francisco, CA 94102, United States"</span>,<span class="hljs-string">"icon"</span>:<span class="hljs-string">"http://frit-talk.com/mobile/2/endirect.png"</span>,<span class="hljs-string">"location"</span>:{<span class="hljs-string">"A"</span>: <span class="hljs-number">37.783724</span>, <span class="hljs-string">"F"</span>: -<span class="hljs-number">122.40897799999999</span>}}
	  	)
	  .expectStatus(<span class="hljs-number">200</span>)
	  .expectHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json; charset=utf-8'</span>)
	  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
	  		frisby.create(<span class="hljs-string">'Upvote'</span>)
	  		  .post(<span class="hljs-string">"http://localhost:3000/api/votes/upVote?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  		  	{ favor: {<span class="hljs-string">"_id"</span>: body._id}, vote: <span class="hljs-number">1</span> }
	  		  	)
	  		  .expectStatus(<span class="hljs-number">200</span>)
	  		  .expectHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html; charset=utf-8'</span>)
	  		  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>changed values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  		          expect(body).toMatch(<span class="hljs-number">1</span>);
	  		        })
	  		.toss();
	          
	        })
	.toss();</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>frisby.create(‘Upvote’)
  .post(“<a href="http://localhost:3000/api/votes/upVote?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU">http://localhost:3000/api/votes/upVote?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU</a>“,
      { favor: {“_id”:”556ca405e30393ac1cc6148f”,”topic”:”yo”,”description”:”yo”,”place_name”:”Hack Reactor”,”address”:”944 Market Street #8, San Francisco, CA 94102, United States”,”user_id”:1,”icon”:”<a href="http://frit-talk.com/mobile/2/endirect.png&quot;,&quot;votes&quot;:0,&quot;isPrivate&quot;:false,&quot;__v&quot;:0,&quot;createdAt&quot;:&quot;2015-06-01T18:27:17.510Z&quot;,&quot;loc&quot;:{&quot;coordinates&quot;:[-122.40897799999999,37.783724],&quot;type&quot;:&quot;Point&quot;},&quot;$$hashKey&quot;:&quot;object:14&quot;}">http://frit-talk.com/mobile/2/endirect.png&quot;,&quot;votes&quot;:0,&quot;isPrivate&quot;:false,&quot;__v&quot;:0,&quot;createdAt&quot;:&quot;2015-06-01T18:27:17.510Z&quot;,&quot;loc&quot;:{&quot;coordinates&quot;:[-122.40897799999999,37.783724],&quot;type&quot;:&quot;Point&quot;},&quot;$$hashKey&quot;:&quot;object:14&quot;}</a>, vote: 1 }
      )
  .expectStatus(200)
  .expectHeader(‘Content-Type’, ‘text/html; charset=utf-8’)
  .afterJSON(function (body) {
          //changed values
          expect(body).toMatch(0);
        })
.toss();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
});

describe(<span class="hljs-string">"Testing a downVote"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>frisby.create(‘downVote’)
  .post(“<a href="http://localhost:3000/api/votes/upVote?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU">http://localhost:3000/api/votes/upVote?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU</a>“,
      { favor: {“_id”:”556ca405e30393ac1cc6148f”,”topic”:”yo”,”description”:”yo”,”place_name”:”Hack Reactor”,”address”:”944 Market Street #8, San Francisco, CA 94102, United States”,”user_id”:1,”icon”:”<a href="http://frit-talk.com/mobile/2/endirect.png&quot;,&quot;votes&quot;:0,&quot;isPrivate&quot;:false,&quot;__v&quot;:0,&quot;createdAt&quot;:&quot;2015-06-01T18:27:17.510Z&quot;,&quot;loc&quot;:{&quot;coordinates&quot;:[-122.40897799999999,37.783724],&quot;type&quot;:&quot;Point&quot;},&quot;$$hashKey&quot;:&quot;object:14&quot;}">http://frit-talk.com/mobile/2/endirect.png&quot;,&quot;votes&quot;:0,&quot;isPrivate&quot;:false,&quot;__v&quot;:0,&quot;createdAt&quot;:&quot;2015-06-01T18:27:17.510Z&quot;,&quot;loc&quot;:{&quot;coordinates&quot;:[-122.40897799999999,37.783724],&quot;type&quot;:&quot;Point&quot;},&quot;$$hashKey&quot;:&quot;object:14&quot;}</a>, vote: -1 }
      )
  .expectStatus(200)
  .expectHeader(‘Content-Type’, ‘text/html; charset=utf-8’)
  .afterJSON(function (body) {
          //changed values
          expect(body).toMatch(0);
        })
.toss();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
	frisby.create(<span class="hljs-string">'Make A Favor'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/api/requests/create?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	    {<span class="hljs-string">"topic"</span>:<span class="hljs-string">"lol4"</span>, <span class="hljs-string">"tags"</span>: <span class="hljs-string">"lol4"</span>, <span class="hljs-string">"description"</span>:<span class="hljs-string">"lol4"</span>,<span class="hljs-string">"place_name"</span>:<span class="hljs-string">"Hack Reactor"</span>,<span class="hljs-string">"address"</span>:<span class="hljs-string">"944 Market Street #8, San Francisco, CA 94102, United States"</span>,<span class="hljs-string">"icon"</span>:<span class="hljs-string">"http://frit-talk.com/mobile/2/endirect.png"</span>,<span class="hljs-string">"location"</span>:{<span class="hljs-string">"A"</span>: <span class="hljs-number">37.783724</span>, <span class="hljs-string">"F"</span>: -<span class="hljs-number">122.40897799999999</span>}}
	  	)
	  .expectStatus(<span class="hljs-number">200</span>)
	  .expectHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json; charset=utf-8'</span>)
	  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
	  		frisby.create(<span class="hljs-string">'Downvote'</span>)
	  		  .post(<span class="hljs-string">"http://localhost:3000/api/votes/upVote?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  		  	{ favor: {<span class="hljs-string">"_id"</span>: body._id}, vote: -<span class="hljs-number">1</span> }
	  		  	)
	  		  .expectStatus(<span class="hljs-number">200</span>)
	  		  .expectHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html; charset=utf-8'</span>)
	  		  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>changed values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  		          expect(body).toMatch(-<span class="hljs-number">1</span>);
	  		        })
	  		.toss();
	          
	        })
	.toss();
  
});

describe(<span class="hljs-string">"Testing Photo"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Dummy Photo'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/api/photos/create-dummy?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  	{<span class="hljs-string">"favor_id"</span>:<span class="hljs-string">"556ca405e30393ac1cc6148f"</span>, <span class="hljs-string">"url"</span>:<span class="hljs-string">"www/example.com"</span>}
	  	)
	  .expectStatus(<span class="hljs-number">201</span>)
	  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>changed values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"THIS IS FOR DUMMY PHOTO!!!! "</span>+<span class="hljs-built_in">JSON</span>.stringify(body));
	        })
	.toss();
  
});

describe(<span class="hljs-string">"Photo Upload"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Dummy Photo'</span>)
	  .get(<span class="hljs-string">"http://localhost:3000/photoUploads/uploadToS3/"</span>,
	  	{ query:{<span class="hljs-string">"fileName"</span>:<span class="hljs-string">"yoyo.jpg"</span>}}
	  	)
	  .expectStatus(<span class="hljs-number">500</span>)
	.toss();
  
});

describe(<span class="hljs-string">"Testing a downVote Photo"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Dummy Photo'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/api/photos/create-dummy?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  	{<span class="hljs-string">"favor_id"</span>:<span class="hljs-string">"556ca405e30393ac1cc6148f"</span>, <span class="hljs-string">"url"</span>:<span class="hljs-string">"www/example.com"</span>}
	  	)
	  .expectStatus(<span class="hljs-number">201</span>)
	  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
	  		frisby.create(<span class="hljs-string">'Downvote'</span>)
	  		  .post(<span class="hljs-string">"http://localhost:3000/api/votes/upVotePhoto?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  		  	{ photo: {<span class="hljs-string">"_id"</span>: body._id}, vote: -<span class="hljs-number">1</span> }
	  		  	)
	  		  .expectStatus(<span class="hljs-number">200</span>)
	  		  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>changed values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  		          expect(body).toMatch(-<span class="hljs-number">1</span>);
	  		        })
	  		.toss();
	          
	        })
	.toss();
  
});

describe(<span class="hljs-string">"Testing an UpVote Photo"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

	frisby.create(<span class="hljs-string">'Dummy Photo'</span>)
	  .post(<span class="hljs-string">"http://localhost:3000/api/photos/create-dummy?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  	{<span class="hljs-string">"favor_id"</span>:<span class="hljs-string">"556ca405e30393ac1cc6148f"</span>, <span class="hljs-string">"url"</span>:<span class="hljs-string">"www/example.com"</span>}
	  	)
	  .expectStatus(<span class="hljs-number">201</span>)
	  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
	  		frisby.create(<span class="hljs-string">'Downvote'</span>)
	  		  .post(<span class="hljs-string">"http://localhost:3000/api/votes/upVotePhoto?access_token=CAAUhHz7c2VoBAHdARERGW4UkcUpCCmUnzf8oDLUyzWGlqZCKklFJa9sfwaqBkirZCsmbozPlpL0271S4NGrd76GpZACFMi6jDtcskXe85Sg46lLuyr6Yj1PtcWMi1q1xt02xGOX3IrZARMSUQaWHKNyWKORQp3u9ucNDSHFHEjHUhr8OcunU"</span>,
	  		  	{ photo: {<span class="hljs-string">"_id"</span>: body._id}, vote: <span class="hljs-number">1</span> }
	  		  	)
	  		  .expectStatus(<span class="hljs-number">200</span>)
	  		  .afterJSON(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>changed values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  		          expect(body).toMatch(<span class="hljs-number">1</span>);
	  		        })
	  		.toss();
	          
	        })
	.toss();
  
});





;
	<span class="hljs-keyword">var</span> topK = {};

	<span class="hljs-keyword">var</span> makeNode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">votes</span>) </span>{
		<span class="hljs-keyword">this</span>.votes = votes || <span class="hljs-number">0</span>;
	}

	<span class="hljs-keyword">var</span> BinaryHeap = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">propertyToCompare, arr, k</span>) </span>{
		<span class="hljs-keyword">this</span>.content = [<span class="hljs-literal">null</span>]

		<span class="hljs-keyword">this</span>.propertyToCompare = propertyToCompare;
		<span class="hljs-keyword">this</span>.k = k;
		<span class="hljs-keyword">if</span>(arr) arr.forEach(<span class="hljs-keyword">this</span>.insert.bind(<span class="hljs-keyword">this</span>));

		<span class="hljs-keyword">this</span>.getVal = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.content[i][propertyToCompare];
		}

	}</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	BinaryHeap.prototype = {

		<span class="hljs-comment">/**
		* API methods
		*/</span>
		isFull: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.content.length &gt; <span class="hljs-keyword">this</span>.k  ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
		},

		isEmpty: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.content.length === <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
		},

		peak: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object</span>) </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.content[<span class="hljs-number">1</span>];
		},

		insert: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object</span>) </span>{


			<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isFull()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>insert into min heap, and bubble to correct position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				topK[object.favorID] = <span class="hljs-keyword">this</span>.content.length;
				<span class="hljs-keyword">this</span>.bubble(<span class="hljs-keyword">this</span>.content.push(object)-<span class="hljs-number">1</span>);
			}
		},


		remove: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

			<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isEmpty()){


				<span class="hljs-keyword">var</span> minObject = <span class="hljs-keyword">this</span>.content[<span class="hljs-number">1</span>];
				<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.content.length === <span class="hljs-number">2</span>) {
					<span class="hljs-keyword">this</span>.content.pop();
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">this</span>.content[<span class="hljs-number">1</span>] = <span class="hljs-keyword">this</span>.content.pop();
					<span class="hljs-keyword">this</span>.sink(<span class="hljs-number">1</span>);
				}

				<span class="hljs-keyword">return</span> minObject;
				
			}
		},

		<span class="hljs-comment">/**
		*auxiliary methods
		*/</span>

		bubble: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) </span>{
			<span class="hljs-keyword">var</span> parentIndex = <span class="hljs-built_in">Math</span>.floor(i/<span class="hljs-number">2</span>);

			<span class="hljs-keyword">if</span>(i&gt;<span class="hljs-number">1</span> &amp;&amp;<span class="hljs-keyword">this</span>.content[parentIndex][<span class="hljs-keyword">this</span>.propertyToCompare] &gt; <span class="hljs-keyword">this</span>.content[i][<span class="hljs-keyword">this</span>.propertyToCompare]) {
				<span class="hljs-keyword">this</span>.swap(i, parentIndex);
				<span class="hljs-keyword">this</span>.bubble(parentIndex);
			}

		},

		sink: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) </span>{
			<span class="hljs-keyword">var</span> childIndex;
			<span class="hljs-keyword">var</span> isLeftLesser;
			<span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.content[i*<span class="hljs-number">2</span>] === <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">this</span>.content[i*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>]=== <span class="hljs-literal">undefined</span> ){
				<span class="hljs-keyword">return</span>;

			}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.content[i*<span class="hljs-number">2</span>] === <span class="hljs-literal">undefined</span>){
				isLeftLesser = <span class="hljs-literal">false</span>;
			}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.content[i*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>] === <span class="hljs-literal">undefined</span>) {
				isLeftLesser = <span class="hljs-literal">true</span>;
			}<span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>both child exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				isLeftLesser = <span class="hljs-keyword">this</span>.content[i*<span class="hljs-number">2</span>][<span class="hljs-keyword">this</span>.propertyToCompare] &lt; <span class="hljs-keyword">this</span>.content[i*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>][<span class="hljs-keyword">this</span>.propertyToCompare];
			}
			
			childIndex = isLeftLesser ? i*<span class="hljs-number">2</span>: i*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>;
			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.content[childIndex][<span class="hljs-keyword">this</span>.propertyToCompare]&lt; <span class="hljs-keyword">this</span>.content[i][<span class="hljs-keyword">this</span>.propertyToCompare]){
				<span class="hljs-keyword">this</span>.swap(i, childIndex);
				<span class="hljs-keyword">this</span>.sink(i);
			}
		},
    	
    	swap: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i,j</span>) </span>{
        	<span class="hljs-keyword">if</span> (j&lt; <span class="hljs-number">0</span>) j += <span class="hljs-keyword">this</span>.content.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>update hashtable with new indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        	topK[<span class="hljs-keyword">this</span>.content[i][<span class="hljs-string">"favorID"</span>]] = j;
        	topK[<span class="hljs-keyword">this</span>.content[j][<span class="hljs-string">"favorID"</span>]] = i;


        	<span class="hljs-keyword">var</span> temp = <span class="hljs-keyword">this</span>.content[i];
        	<span class="hljs-keyword">this</span>.content[i] = <span class="hljs-keyword">this</span>.content[j];
        	<span class="hljs-keyword">this</span>.content[j] = temp;

    	}


	}



	<span class="hljs-comment">/**
	*	Look at element in data stream
	*/</span>
		<span class="hljs-keyword">var</span> h = <span class="hljs-keyword">new</span> BinaryHeap(<span class="hljs-string">"count"</span>,[],<span class="hljs-number">3</span>);
		<span class="hljs-keyword">var</span> decrementCounter = <span class="hljs-number">0</span>;

	<span class="hljs-keyword">var</span> processNew = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">favorID</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>check whether favor is already in top K</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(topK[favorID]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>if already in topK, increment it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			h.content[topK[favorID]].count++;
			h.sink(topK[favorID]);
		}<span class="hljs-keyword">else</span> {

			<span class="hljs-keyword">if</span>(h.isFull()){</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>if full, decrement everything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				decrementCounter--;
				<span class="hljs-keyword">var</span> minElement= h.peak();

				<span class="hljs-keyword">while</span>( minElement &amp;&amp; minElement.count + decrementCounter &lt;=<span class="hljs-number">0</span> ) {
					h.remove();
					<span class="hljs-keyword">delete</span> topK[minElement.favorID];
					minElement  = h.peak();
				}
				
			} <span class="hljs-keyword">else</span> {
				h.insert({favorID:favorID, count:<span class="hljs-number">1</span> - decrementCounter});
			}

		}

		
	};

	processNew(<span class="hljs-string">'a'</span>);
	processNew(<span class="hljs-string">'b'</span>);
	processNew(<span class="hljs-string">'c'</span>);
	processNew(<span class="hljs-string">'c'</span>);
	processNew(<span class="hljs-string">'a'</span>);

	<span class="hljs-built_in">console</span>.log(h.content);
	<span class="hljs-built_in">console</span>.log(topK);

	processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'e'</span>)


	<span class="hljs-built_in">console</span>.log(h.content);
	<span class="hljs-built_in">console</span>.log(topK);
	processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'e'</span>);

processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'e'</span>);processNew(<span class="hljs-string">'d'</span>);
		processNew(<span class="hljs-string">'d'</span>);

	<span class="hljs-built_in">console</span>.log(h.content);
	<span class="hljs-built_in">console</span>.log(topK);

<span class="hljs-comment">/**
* Now figure out whether the frequencies are accurate
* auto time expiry nodes 
*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>var heap = new BinaryHeap(“”,[1],3);
heap.remove();</p>

            </div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>heap.remove();
heap.insert(1);
heap.insert(2);
heap.remove();
heap.insert(2);</p>

            </div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>heap.remove();
heap.remove();</p>

            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>console.log(heap.content);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
;<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);
<span class="hljs-keyword">var</span> Q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Update the user's location coordinates in their table
   * @method updateLocation
   * @param {Object} req
   * @param {Object} res
   * @param {Object} next
   * @return 
   */</span>
  updateLocation: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    User.findOne({
      provider_id: req.user.provider_id,
    }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error updating location for user: '</span>, user);
        res.send(<span class="hljs-string">'Error fetching user for update'</span> + err);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'fetched user for update: '</span>, user);
        user.loc.coordinates = [req.body.lng, req.body.lat];
        user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'errror updating user'</span>, err);
            res.send(<span class="hljs-string">'Error updating user'</span> + err);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Successfully updated user'</span>);
            res.send(<span class="hljs-string">'Successfully updated user'</span>);
          }
        });
      }
    });
  },
  <span class="hljs-comment">/**
   * Update the user's location coordinates in their table
   * @method update
   * @param {Object} req
   * @param {Object} res
   * @param {Function} next
   * @return 
   */</span>
  update: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'updateLocation: '</span>, req.body);
    User.findOne({
      provider_id: req.user.provider_id,
    }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error updating location for user: '</span>, user);
        res.send(<span class="hljs-string">'Error fetching user for update'</span> + err);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'fetched user for update: '</span>, user);
        <span class="hljs-keyword">if</span> (req.body.notify_favors !== <span class="hljs-literal">undefined</span>) {
          user.notify_favors = req.body.notify_favors;
          user.notify_photos = req.body.notify_photos;
          req.user.notify_photos = user.notify_photos;
          req.user.notify_favors = user.notify_favors;
        }
        <span class="hljs-keyword">if</span> (req.body.lng !== <span class="hljs-literal">undefined</span>) {
          user.loc.coordinates = [req.body.lng, req.body.lat];
        }
        user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'errror updating user'</span>, err);
            res.send(<span class="hljs-string">'Error updating user'</span> + err);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Successfully updated user'</span>);
            res.send(<span class="hljs-string">'Successfully updated user'</span>);
          }
        });
      }
    });
  }
};
;<span class="hljs-keyword">var</span> userController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./userController.js'</span>);

<span class="hljs-comment">/**
 * Description
 * @method exports
 * @param {} app
 * @return 
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{

	app.use(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res, next</span>)</span>{
    <span class="hljs-keyword">if</span> (req.body.location) {
      req.body.lng = req.body.location.longitude;
      req.body.lat = req.body.location.latitude;
      req.body.timeStamp = req.body.location.recorded_at;
    }
    next();
  	});

  app.route(<span class="hljs-string">'/updateloc'</span>)
    .post(userController.updateLocation);
   app.route(<span class="hljs-string">'/update'</span>)
    .post(userController.update);
};

;<span class="hljs-comment">/**
 * Description: given a lng/lat point returns the bounding box for a 1-mile radius
 * @method getBoxForLoc
 * @param {Array[lng, lat]} coords
 * @return {Array} box
 */</span>
<span class="hljs-keyword">var</span> getBoxForLoc = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">coords</span>) </span>{
  <span class="hljs-keyword">var</span> miles = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">var</span> radius = <span class="hljs-number">0.02899</span> * miles;
  <span class="hljs-keyword">var</span> box = [
    [coords[<span class="hljs-number">0</span>] - radius, coords[<span class="hljs-number">1</span>] - radius], <span class="hljs-comment">//sw</span>
    [coords[<span class="hljs-number">0</span>] + radius, coords[<span class="hljs-number">1</span>] + radius]
  ]; <span class="hljs-comment">//ne</span>
  <span class="hljs-keyword">return</span> box;
};

<span class="hljs-comment">/**
 * Description: return a polygon box for sw/ne coordinates
 * @method getPolyBoxQuery
 * @param {Array[sw,ne]} box
 * @return ObjectExpression
 */</span>
<span class="hljs-keyword">var</span> getPolyBoxQuery = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">box</span>) </span>{
  <span class="hljs-keyword">var</span> polyBox = [ <span class="hljs-comment">// sw, ne</span>
    [
      [box[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], box[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]],
      [box[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>], box[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]],
      [box[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>], box[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]],
      [box[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], box[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]],
      [box[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], box[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]]
    ]
  ];
  <span class="hljs-keyword">return</span> {
    <span class="hljs-string">"loc"</span>: {
      <span class="hljs-string">"$geoWithin"</span>: {
        <span class="hljs-string">"$geometry"</span>: {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"Polygon"</span>,
          <span class="hljs-string">"coordinates"</span>: polyBox
        }
      }
    }
  }
};

<span class="hljs-built_in">module</span>.exports = {
  getBoxForLoc: getBoxForLoc,
  getPolyBoxQuery: getPolyBoxQuery
};;<span class="hljs-keyword">var</span> Favor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/favorModel.js'</span>);
<span class="hljs-keyword">var</span> Photo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/photoModel.js'</span>);
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/userModel.js'</span>);

<span class="hljs-keyword">var</span> Q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);
<span class="hljs-keyword">var</span> Vote = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/voteModel.js'</span>);

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Function does both upvoting and downvoting
   * @method upVote
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  upVote: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Query the Vote table for entries with a certain userID and favorID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Vote.findOne({
      userID: req.user.provider_id,
      favorID: req.body.favor._id
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, vote</span>) </span>{
      
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"favorID"</span>, req.body.favor._id);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"THIS IS USER VOTE! "</span>+vote);
      <span class="hljs-built_in">console</span>.log(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>console.log(‘ERROR in finding user on login: ‘, err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> (err);</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>console.log(‘LOGIN no error, user: ‘, user);</p>

            </div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>check if there’s already a vote by this user…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!err &amp;&amp; vote != <span class="hljs-literal">null</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'you already voted on that...'</span>); 
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.body.vote"</span>, req.body.vote);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"vote.vote"</span>, vote.vote);</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>If req.body.vote = 1, upvote; 0, nuetral; -1, downvote
If sending an upvote, check if there is already a downvote</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (req.body.vote === <span class="hljs-number">1</span> &amp;&amp; (vote.vote ===-<span class="hljs-number">1</span> || vote.vote ===<span class="hljs-number">0</span>))  {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Increase the votes by 1 in both the votes and favors tables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: <span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'succesfully did findbyidandupdate'</span>);
                Favor.findByIdAndUpdate(req.body.favor._id, 
                { $inc: {votes: <span class="hljs-number">1</span> } }, 
                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                  User.findByIdAndUpdate(req.user._id,
                    { $inc: {points: <span class="hljs-number">1</span> } },
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'succesfully did points!!!!!!!!!!!!!'</span>);
                      res.send(<span class="hljs-string">'1'</span>);
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>console.log(“AWWWW im in callback”)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                });
              });


        }

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.body.vote === -<span class="hljs-number">1</span> &amp;&amp; (vote.vote === <span class="hljs-number">1</span>|| vote.vote ===<span class="hljs-number">0</span>)){</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Decrease a specific entry in both the favor and vote table by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: -<span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                  Favor.findByIdAndUpdate(req.body.favor._id, 
                  { $inc: {votes: -<span class="hljs-number">1</span> } }, 
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                        <span class="hljs-keyword">if</span> (data.votes &lt;= -<span class="hljs-number">4</span>) {
                          data.remove()
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.votes &gt; -<span class="hljs-number">5</span>){
                          User.findByIdAndUpdate(req.user._id,
                            { $inc: {points: -<span class="hljs-number">1</span> } },
                            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                              res.send(<span class="hljs-string">'-1'</span>);
                            });
                        }
                  });
              });
          
        } <span class="hljs-keyword">else</span> { 
          res.send(<span class="hljs-string">'0'</span>); 
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>//otherwise, you’ve already voted. send back 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Create a new vote entry and save it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> vote = <span class="hljs-keyword">new</span> Vote({
        userID: req.user.provider_id,
        favorID: req.body.favor._id,
        vote: req.body.vote
      });
      vote.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR in user creation on login: '</span>, err);
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;

        <span class="hljs-keyword">if</span>( vote.vote === <span class="hljs-number">1</span>) {
          Favor.findByIdAndUpdate(req.body.favor._id,
            { $inc: {votes: <span class="hljs-number">1</span>} },
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
              res.send(<span class="hljs-string">'1'</span>);
            });
        } <span class="hljs-keyword">else</span> { 
          Favor.findByIdAndUpdate(req.body.favor._id,
          { $inc: {votes: -<span class="hljs-number">1</span>} },
          <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            res.send(<span class="hljs-string">'-1'</span>); 
          });
        }
      });
      }
    });
    

  },


  <span class="hljs-comment">/**
   * This function does both upvoting and downvoting for photos
   * @method upVotePhoto
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  upVotePhoto: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Query the Vote table for a specific entry with a certain photo/userID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Vote.findOne({
      userID: req.user.provider_id,
      photoID: req.body.photo._id
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, vote</span>) </span>{
      
      <span class="hljs-built_in">console</span>.log(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>console.log(‘ERROR in finding user on login: ‘, err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> (err);</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>check if there’s already a vote by this user…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!err &amp;&amp; vote != <span class="hljs-literal">null</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'you already voted on that...'</span>); 
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.body.vote"</span>, req.body.vote);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"vote.vote"</span>, vote.vote);
        <span class="hljs-keyword">if</span> (req.body.vote === <span class="hljs-number">1</span> &amp;&amp; (vote.vote ===-<span class="hljs-number">1</span> || vote.vote ===<span class="hljs-number">0</span>))  { <span class="hljs-comment">//if sending an upvote, check if there is already a downvote</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>find that exact vote, photo, and up the user’s kudos by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: <span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                Photo.findByIdAndUpdate(req.body.photo._id, 
                { $inc: {votes: <span class="hljs-number">1</span> } }, 
                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                  User.findByIdAndUpdate(req.user._id,
                    { $inc: {points: <span class="hljs-number">1</span> } },
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                      res.send(<span class="hljs-string">'1'</span>);
                    });
                });
              });

        }

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.body.vote === -<span class="hljs-number">1</span> &amp;&amp; (vote.vote === <span class="hljs-number">1</span>|| vote.vote ===<span class="hljs-number">0</span>)){</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>find that exact vote, photo, and down the user’s kudos by 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Vote.findByIdAndUpdate(vote._id,
              { $inc: {vote: -<span class="hljs-number">1</span> } },
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                Photo.findByIdAndUpdate(req.body.photo._id, 
                { $inc: {votes: -<span class="hljs-number">1</span> } }, 
                  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                    <span class="hljs-keyword">if</span> (data.votes &lt;= -<span class="hljs-number">4</span>) {
                      data.remove()
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.votes &gt; -<span class="hljs-number">5</span>){
                      User.findByIdAndUpdate(req.user._id,
                        { $inc: {points: -<span class="hljs-number">1</span> } },
                        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                          res.send(<span class="hljs-string">'1'</span>);
                        });
                    }
                  });
              });
          
        } <span class="hljs-keyword">else</span> { 
          res.send(<span class="hljs-string">'0'</span>); 
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>//otherwise, you’ve already voted. send back 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Create a new vote table if one does not already exist!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> vote = <span class="hljs-keyword">new</span> Vote({
        userID: req.user.provider_id,
        photoID: req.body.photo._id,
        vote: req.body.vote
      });
      vote.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR in user creation on login: '</span>, err);
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;

        <span class="hljs-keyword">if</span>( vote.vote === <span class="hljs-number">1</span>) {
          Photo.findByIdAndUpdate(req.body.photo._id,
            { $inc: {votes: <span class="hljs-number">1</span>} },
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
              res.send(<span class="hljs-string">'1'</span>);
            });
        } <span class="hljs-keyword">else</span> { 
          Photo.findByIdAndUpdate(req.body.photo._id,
          { $inc: {votes: -<span class="hljs-number">1</span>} },
          <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            res.send(<span class="hljs-string">'-1'</span>); 
          });
        }
      });
      }
    });
    

  }
}
;<span class="hljs-keyword">var</span> Favor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/favorModel.js'</span>);
<span class="hljs-keyword">var</span> VotePhoto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db/votePhotoModel.js'</span>);


<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-comment">/**
   * Description
   * @method upVote
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  upVote: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  },

  <span class="hljs-comment">/**
   * Description
   * @method downVote
   * @param {} req
   * @param {} res
   * @param {} next
   * @return 
   */</span>
  downVote: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  }
}
;<span class="hljs-keyword">var</span> voteController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./voteController.js'</span>);
<span class="hljs-keyword">var</span> votePhotoController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./votePhotoController.js'</span>);

<span class="hljs-comment">/**
 * Description
 * @method exports
 * @param {} app
 * @return 
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
  app.route(<span class="hljs-string">'/upVote'</span>)
    .post(voteController.upVote);</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>app.route(‘/downVote’)
  .post(voteController.downVote);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  app.route(<span class="hljs-string">'/upVotePhoto'</span>)
  	.post(voteController.upVotePhoto);

};;<span class="hljs-keyword">var</span> instagram = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./instagramScrape.js'</span>);

<span class="hljs-comment">/**
 * Description
 * @method exports
 * @param {} app
 * @return 
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
	app.post(<span class="hljs-string">'/'</span>, instagram.getPhotosByLocation);
};
;<span class="hljs-keyword">var</span> ig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'instagram-node'</span>).instagram();

	<span class="hljs-keyword">var</span> igCredentials;

<span class="hljs-keyword">if</span>(process.env.PRODUCTION) {
	ig.use({
		client_id: process.env.instagram_clientID,
		client_secret: process.env.instagram_client_secret 
	});
} <span class="hljs-keyword">else</span> {
	igCredentials = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./instagramCredentials.js'</span>);

	ig.use({
		client_id: igCredentials.instagram_client_ID,
		client_secret: igCredentials.instagram_client_secret 
	});
}




<span class="hljs-built_in">module</span>.exports =  {
	<span class="hljs-comment">/**
	 * Description
	 * @method getPhotosByLocation
	 * @param {} req
	 * @param {} res
	 * @return 
	 */</span>
	getPhotosByLocation: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>console.log(, req.body.long);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.body"</span>)
		<span class="hljs-built_in">console</span>.log(req.body);

		ig.location_search({ lat: req.body.lat, lng: req.body.long }, {distance:<span class="hljs-number">100</span>} ,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result, remaining, limit</span>) </span>{

			<span class="hljs-built_in">console</span>.log(result);
			ig.location_media_recent(result[<span class="hljs-number">0</span>].id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result, pagination, remaining, limit</span>) </span>{
				res.json(result);
			});			
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>ig.location_media_recent(‘16334271’, function(err, result, pagination, remaining, limit) {
    res.json(result);
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	}
}


;<span class="hljs-comment">// var twitter = require('./twitterScrape.js');</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>module.exports = function(app) {
    app.get(‘/‘, twitter.getPhotosByLocation);
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>;<span class="hljs-comment">// var Twitter = require("twitter");</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>var credentials = require(‘./twitterCredentials.js’);</p>

            </div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>var client = Twitter({
    consumer_key: credentials.consumer_key,
    consumer_secret: credentials.consumer_secret,
    access_token_key: credentials.access_token_key,
    access_token_secret: credentials.access_token_secret
});</p>

            </div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>module.exports = {</p>

            </div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <pre><code>getPhotosByLocation: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"I'm here oh yea"</span>);
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <pre><code>    client.get(<span class="hljs-string">'search/tweets'</span>, {
        q: <span class="hljs-string">"marina bay sands"</span>,
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <pre><code>        result_type: <span class="hljs-string">'recent'</span>,
        count: <span class="hljs-number">5</span>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, tweets, response</span>) </span>{
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <pre><code>        <span class="hljs-keyword">if</span> (error) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Error getting data from Twitter API"</span>);
            <span class="hljs-built_in">console</span>.log(error);
            res.send(<span class="hljs-number">404</span>, <span class="hljs-string">"Sorry, bad Twitter handle - try again"</span>);
        } <span class="hljs-keyword">else</span> {
            res.json(tweets);
        }
    })
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <pre><code>}
</code></pre><p>}</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
